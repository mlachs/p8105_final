---
title: "mos2128"
author: "Mari Sanders"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(httr)
library(leaflet)
```

## Data Importing and Cleaning 

```{r}
res=GET('https://developer.nps.gov/api/v1/parks?limit=500&api_key=B9nDpbkbrb3kSOjz6kXSxMJ3d6MSpUvt1QqYdeyn')

data = res %>% content("text") %>% jsonlite::fromJSON() %>% as_tibble()

NPS_data=data %>% unnest(data) %>% select(fullName,latitude,longitude,topics, activities,states, parkCode) %>%  janitor::clean_names() %>% 
  mutate(
    latitude = as.numeric(latitude), 
    longitude = as.numeric(longitude)
  ) %>% unnest(activities, names_sep = "_") %>% 
  unnest(topics, names_sep = "_")
visitation_data <- 
  read_csv("data/Query Builder for Public Use Statistics (1979 - Last Calendar Year).csv") %>% 
  janitor::clean_names() %>% 
  mutate(unit_code = tolower(unit_code)) %>% 
  rename(park_code = unit_code, 
         full_name = park_name) %>% 
  select(full_name, park_code, park_type, region, state, year, month, recreation_visits, tent_campers, rv_campers, tent_campers, backcountry)

combined_data <- full_join(NPS_data, visitation_data, by = c("park_code"))
``` 


## Total Trend by Park Type Across Months

```{r}
visitation_data %>% 
  group_by(park_type, month) %>% 
  summarize(total_visitation = sum(recreation_visits)) %>% 
plot_ly(x = ~as.factor(month), y = ~total_visitation, type = "scatter", mode = "lines", color = ~park_type)

visitation_data %>% 
  group_by(park_type) %>% 
  summarize(parks = n_distinct(full_name)) %>% knitr::kable()
```

As seen in the graph, national parks have the highest total visitation among all park types. Interestingly, there more national monuments, national historic sites, and national historic parks than national parks, even though all of these have less total visitation than national parks. 

## Total Visitation by Visitation Type and Season

The `visitation_data` data set also includes information on visitation split by `tent_campers`, `backcountry`, and `rv_campers`. We were interested in looking at the total visitation split by these three visitation types and by season. 

```{r}
visitation_data %>% 
  mutate(season = case_when(
    month %in% c(12,1,2) ~ "Winter", 
    month %in% c(3,4,5) ~ "Spring", 
    month %in% c(6,7,8) ~ "Summer", 
    TRUE ~ "Fall"
  )) %>% 
  group_by(season) %>% 
  summarize(total_tent = sum(tent_campers), 
            backcountry_visits = sum(backcountry), 
            total_rv = sum(rv_campers)) %>% 
  pivot_longer(
    total_tent:total_rv, 
    values_to = "total_visit", 
    names_to = "type_visit",
    names_prefix = "total_"
  ) %>% 
  plot_ly(x = ~season, y = ~total_visit, color = ~type_visit, type = "bar")
```

In fall, winter, and spring, the highest visitation is `tent_campers`, with a peak summer. Interestingly and unsurprisingly, the highest visitation in winter is `rv_campers`. This is probably due to weather conditions not permitting tent camping, but allows for rv camping. 
For fall, winter, and spring there is a similar trend where `backcountry` has the lowest total visitation and `tent_campers` has the highest visitation. In winter, `rv_campers` has the highest total visitation, then `tent_campers`, and then `backcountry`. 

## Average Park Visitation by Season and Park Type

Next, we were interested in seeing the trends in park visitation by season and park type. 

```{r}
park_types <- unique(visitation_data$park_type)
plots <- list()
for (i in seq_along(park_types)) {
plots[[i]] <- visitation_data %>% 
    filter(park_type == park_types[i]) %>% 
    mutate(season = case_when(
      month %in% c(12, 1, 2) ~ "Winter", 
      month %in% c(3, 4, 5) ~ "Spring", 
      month %in% c(6, 7, 8) ~ "Summer", 
      TRUE ~ "Fall"
    )) %>% 
    group_by(season) %>%
    summarize(avg_visits = mean(recreation_visits, na.rm = TRUE)) %>%
    ggplot(aes(x = season, y = avg_visits, fill = season)) +
    geom_col() +
    ggtitle(paste("Average Visits by Season for", park_types[i])) 
} 
plots
```

Most of the parks have a similar trend in average visitation, where summer is the highest and winter is the lowest. 

## National Lakeshore Seasonal Trends and Activities

For `national lakeshore` parks, there is a really stark difference in average visits between summer and the other seasons. 

```{r}
combined_data %>% 
  group_by(park_type) %>% 
  summarize(count = n_distinct(activities_name)) %>% arrange(desc(count))
activities_count <- 
  combined_data %>% 
  filter(park_type == "National Lakeshore") %>% distinct(activities_name) %>% nrow()

combined_data %>% 
  filter(park_type == "National Lakeshore") %>% distinct(activities_name) %>% knitr::kable()
```

Based on the activities offered in National Lakeshore, we can see that most of the activities revolve around water, such as `canoeing`, `fly fishing`, and `jet skiing`. 
Interestingly, at National Lakeshore, there are skiing activities, but the winter average visits are still the lowest. 

##National Preserve Seasonal Trends and Activities

```{r}
plots[10]
```

Another interesting pattern is that in National Preserve, there is a higher average visitation in spring than summer and winter has a higher visitation than fall.  

```{r}
activities_count <- 
  combined_data %>% 
  filter(park_type == "National Preserve") %>% distinct(activities_name) %>% nrow()
combined_data %>% 
  filter(park_type == "National Preserve") %>% distinct(activities_name)  %>% knitr::kable()
```

There are `r activities_count` activities offered at this park. It is near the middle of the distribution of total activities, so the trend is not due to having many more activities offered than other park types. It seems like there is a much bigger variety in the types of activities offered at these parks. There are tours, stargazing, biking, picnicking, hunting, water activities, wildlife watching, museums and stores, as well as winter activities like skiing, and snowshoeing. 

## International Historic Site Seasonal Trends and Activities

```{r}
plots[18]
```

This plot is interesting because there is no average visitation in winter. 

```{r}
activities_count <- 
  combined_data %>% 
  filter(park_type == "International Historic Site") %>% distinct(activities_name) %>% nrow()
combined_data %>% 
  filter(park_type == "International Historic Site") %>% distinct(activities_name)  %>% knitr::kable()
```

There are `r activities_count` activities offered at this park type. It makes sense that there is no visitation in the winter because the only activities offered are `paddling`, `junior ranger program` and `wildlife watching`. There are no activities that would really be done in the winter at these parks. 

##Average Visitation by Visit and Park Type 


```{r}
park_types <- unique(visitation_data$park_type)
plots <- list()

for (i in seq_along(park_types)) {
  visit_summary <- visitation_data %>% 
    filter(park_type == park_types[i]) %>% 
    mutate(season = case_when(
      month %in% c(12, 1, 2) ~ "Winter", 
      month %in% c(3, 4, 5) ~ "Spring", 
      month %in% c(6, 7, 8) ~ "Summer", 
      TRUE ~ "Fall"
    )) %>% 
    group_by(season) %>% 
    summarize(
      mean_tent = mean(tent_campers, na.rm = TRUE), 
      mean_backcountry = mean(backcountry, na.rm = TRUE), 
      mean_rv = mean(rv_campers, na.rm = TRUE)
    ) %>% 
    pivot_longer(
      cols = starts_with("mean_"), 
      names_to = "type_visit", 
      values_to = "mean", 
      names_prefix = "mean_"
    ) 
  

  plots[[i]] <- ggplot(visit_summary, aes(x = season, y = mean)) + 
    geom_col() + facet_grid(~type_visit) +
    ggtitle(paste("Average Visits by Season for", park_types[i]))
}

plots

park_types <- unique(visitation_data$park_type)
plots <- list()
for (i in seq_along(park_types)) {
plots[[i]] <- visitation_data %>% 
    filter(park_type == park_types[i]) %>% 
    mutate(season = case_when(
      month %in% c(12, 1, 2) ~ "Winter", 
      month %in% c(3, 4, 5) ~ "Spring", 
      month %in% c(6, 7, 8) ~ "Summer", 
      TRUE ~ "Fall"
    )) %>% 
    group_by(season) %>%
    summarize(avg_visits = mean(recreation_visits, na.rm = TRUE)) %>%
    ggplot(aes(x = season, y = avg_visits, fill = season)) +
    geom_col() +
    ggtitle(paste("Average Visits by Season for", park_types[i])) 
} 
plots
```



map of all national parks in US

```{r,eval = FALSE}
leaflet(data = NPS_data) %>% 
  addTiles() %>% 
  addMarkers(~longitude, ~latitude) %>%
  setView(lng = -98.583, lat = 39.828, zoom = 4)
```


Average visitation by type and park_type (separate graph for each park_type)



Regional Comparisons 
```{r}
region_data <- visitation_data %>% 
  mutate(region = case_when(
    state %in% c("CT", "RI", "NH", "VT", "NJ", "NY", "PA", "MD", "ME", "MA") ~ "northeast", 
    state %in% c("IL","IN", "MI", "OH", "WI", "IA", "KS", "MN", "MO", "NE", "ND", "SD") ~ "midwest", 
    state %in% c("FL", "GA", "NC", "SC", "VA", "DE", "WV", "AL", "KY", "MS", "TN", "AR", "LA", "OK", "TX", "DC") ~ "south", 
    state %in% c("AK", "CA", "HI", "OR", "WA", "AZ", "CO", "ID", "MT", "NV", "NM", "UT", "WY") ~ "west",
    state %in% c("VI", "AS", "GU", "PR") ~ "u.s. territory",
    TRUE ~ "no state data"
  ))
```

```{r}
region_data <- combined_data %>% 
  mutate(region = case_when(
    state %in% c("CT", "RI", "NH", "VT", "NJ", "NY", "PA", "MD", "ME", "MA") ~ "northeast", 
    state %in% c("IL","IN", "MI", "OH", "WI", "IA", "KS", "MN", "MO", "NE", "ND", "SD") ~ "midwest", 
    state %in% c("FL", "GA", "NC", "SC", "VA", "DE", "WV", "AL", "KY", "MS", "TN", "AR", "LA", "OK", "TX", "DC") ~ "south", 
    state %in% c("AK", "CA", "HI", "OR", "WA", "AZ", "CO", "ID", "MT", "NV", "NM", "UT", "WY") ~ "west",
    state %in% c("VI", "AS", "GU", "PR") ~ "u.s. territory",
    state == TRUE ~ "no state data"
  )) %>% select(c(-full_name.y, -topics_id, -topics_name, -activities_id))
```

Northeast

```{r}
region_data %>%
  filter(region == "northeast") %>% drop_na() %>% 
  distinct(park_type) %>% knitr::kable()
region_data %>%
  filter(region == "northeast") %>% distinct(activities_name) 

region_data %>%
  filter(region == "northeast") %>% 
  mutate(season = case_when(
      month %in% c(12, 1, 2) ~ "Winter", 
      month %in% c(3, 4, 5) ~ "Spring", 
      month %in% c(6, 7, 8) ~ "Summer", 
      TRUE ~ "Fall"
    )) %>% 
    group_by(season) %>% 
    summarize(
      mean_tent = mean(tent_campers, na.rm = TRUE), 
      mean_backcountry = mean(backcountry, na.rm = TRUE), 
      mean_rv = mean(rv_campers, na.rm = TRUE)
    ) %>% 
    pivot_longer(
      cols = starts_with("mean_"), 
      names_to = "type_visit", 
      values_to = "mean", 
      names_prefix = "mean_"
    ) %>% ggplot(aes(x = season, y = mean)) + geom_col() +  facet_grid(~type_visit)
```

Midwest 

```{r}
region_data %>%
  filter(region == "midwest") %>%
  drop_na() %>% 
  distinct(park_type) %>% knitr::kable()
region_data %>%
  filter(region == "midwest") %>% distinct(activities_name) 

region_data %>%
  filter(region == "midwest") %>% 
  mutate(season = case_when(
      month %in% c(12, 1, 2) ~ "Winter", 
      month %in% c(3, 4, 5) ~ "Spring", 
      month %in% c(6, 7, 8) ~ "Summer", 
      TRUE ~ "Fall"
    )) %>% 
    group_by(season) %>% 
    summarize(
      mean_tent = mean(tent_campers, na.rm = TRUE), 
      mean_backcountry = mean(backcountry, na.rm = TRUE), 
      mean_rv = mean(rv_campers, na.rm = TRUE)
    ) %>% 
    pivot_longer(
      cols = starts_with("mean_"), 
      names_to = "type_visit", 
      values_to = "mean", 
      names_prefix = "mean_"
    ) %>% ggplot(aes(x = season, y = mean)) + geom_col() +  facet_grid(~type_visit)
```


South 
```{r}
region_data %>%
  filter(region == "south") %>%
  drop_na() %>% 
  distinct(park_type) %>% 
  knitr::kable()
region_data %>%
  filter(region == "south") %>%
  distinct(activities_name) 

region_data %>%
  filter(region == "south") %>% 
  mutate(season = case_when(
      month %in% c(12, 1, 2) ~ "Winter", 
      month %in% c(3, 4, 5) ~ "Spring", 
      month %in% c(6, 7, 8) ~ "Summer", 
      TRUE ~ "Fall"
    )) %>% 
    group_by(season) %>% 
    summarize(
      mean_tent = mean(tent_campers, na.rm = TRUE), 
      mean_backcountry = mean(backcountry, na.rm = TRUE), 
      mean_rv = mean(rv_campers, na.rm = TRUE)
    ) %>% 
    pivot_longer(
      cols = starts_with("mean_"), 
      names_to = "type_visit", 
      values_to = "mean", 
      names_prefix = "mean_"
    ) %>% ggplot(aes(x = season, y = mean)) + geom_col() +  facet_grid(~type_visit)
```

west 

```{r}
region_data %>% filter(region == "west") %>% drop_na() %>% 
  distinct(park_type) %>% knitr::kable()
region_data %>% filter(region == "west") %>% distinct(activities_name) 

region_data %>% 
  filter(region == "west") %>% 
  mutate(season = case_when(
      month %in% c(12, 1, 2) ~ "Winter", 
      month %in% c(3, 4, 5) ~ "Spring", 
      month %in% c(6, 7, 8) ~ "Summer", 
      TRUE ~ "Fall"
    )) %>% 
    group_by(season) %>% 
    summarize(
      mean_tent = mean(tent_campers, na.rm = TRUE), 
      mean_backcountry = mean(backcountry, na.rm = TRUE), 
      mean_rv = mean(rv_campers, na.rm = TRUE)
    ) %>% 
    pivot_longer(
      cols = starts_with("mean_"), 
      names_to = "type_visit", 
      values_to = "mean", 
      names_prefix = "mean_"
    ) %>% ggplot(aes(x = season, y = mean)) + 
  geom_col() +  
  facet_grid(~type_visit)
```

Comparing Regions 

```{r}
region_data %>% group_by(region) %>% 
  summarize(avg_visitation = mean(recreation_visits, na.rm = TRUE)) %>% 
  arrange(desc(avg_visitation))

region_long <- region_data %>%
  pivot_longer(cols = c(recreation_visits, tent_campers, rv_campers, backcountry), 
               names_to = "visit_type", 
               values_to = "count") %>% view()
region_data %>%
  group_by(region) %>%
  summarize(
    mean_tent = mean(tent_campers, na.rm = TRUE),
    mean_backcountry = mean(backcountry, na.rm = TRUE),
    mean_rv = mean(rv_campers, na.rm = TRUE)
  ) %>%
  pivot_longer(
    cols = starts_with("mean_"),
    names_to = "type_visit",
    values_to = "mean",
    names_prefix = "mean_"
  ) %>% ggplot(aes(x = region, y = mean)) + geom_col() + facet_grid(~type_visit) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
  
```

```{r}
region_data %>% 
  filter(region == "u.s. territory") %>% 
  distinct(activities_name) 
  
region_data %>% 
  filter(region == "no state data") %>%  
  distinct(activities_name)

region_data %>% 
  group_by(region) %>% 
  summarize(parks = n_distinct(park_code)) %>% knitr::kable()
```

